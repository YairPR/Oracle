********************************************************************************************************
*  SCRIPTS DE AYUDA DATAGUARD                  
********************************************************************************************************
--> EN CONTINGENCIA

-- Busca los log aplicados en el ultimo día
set line 1000
SELECT SEQUENCE#, 
       to_char(FIRST_TIME,'hh24:mi:ss dd/mm/yyyy'), 
       to_char(NEXT_TIME,'hh24:mi:ss dd/mm/yyyy'),
       APPLIED 
 FROM V$ARCHIVED_LOG 
 where next_time>sysdate-1 
 ORDER BY SEQUENCE# ;


-- Busca ultimo log aplicado
SELECT to_char(max(FIRST_TIME),
       'hh24:mi:ss dd/mm/yyyy') 
FROM V$ARCHIVED_LOG 
WHERE applied='YES';
 
-- ¿Que esta haciendo los procesos background de Dataguard?
  SELECT PROCESS, STATUS, THREAD#, SEQUENCE#, BLOCK#, BLOCKS 
  FROM V$MANAGED_STANDBY;
 
-- ¿Estamod en Producción o en Contingencia?
 SELECT DATABASE_ROLE, DB_UNIQUE_NAME INSTANCE, OPEN_MODE, PROTECTION_MODE, PROTECTION_LEVEL, SWITCHOVER_STATUS 
 FROM V$DATABASE;
 
-- Revisar Errores
 SELECT MESSAGE FROM V$DATAGUARD_STATUS;
 
-- Check that the DB was openned correctly 
 SELECT RECOVERY_MODE FROM V$ARCHIVE_DEST_STATUS;

-- stadisticas lag importantes
 select * from v$dataguard_stats;


-- iniciar y detener la sincronización en Dataguard
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE disconnect; (?)

Bajar:
alter database recover managed standby database cancel;

Activar
alter database recover managed standby database disconnect from session;

Verificar
select process,status,thread#,sequence# from v$managed_standby;


-- Registrar manualmente archivelog
alter database register physical logfile '<fullpath/filename>';

-- Compruebe si los registros en espera están configurados correctamente

set lines 100 pages 999
col member format a70
SELECT	st.group#,
       st.sequence#,
       ceil(st.bytes / 1048576) mb,
       lf.member
FROM	v$standby_log	st,	v$logfile	lf
WHERE	st.group# = lf.group#
/

-- EN PRIMARIO
 -- configurar envío de archuvelog en primario
alter system set log_archive_dest_3='SERVICE=DEVPCOMB LGWR ASYNC VALID_FOR=(ONLINE_LOGFILES, PRIMARY_ROLE) DB_UNIQUE_NAME=DEVPCOMB';
alter system set log_archive_dest_state_3='enable';
